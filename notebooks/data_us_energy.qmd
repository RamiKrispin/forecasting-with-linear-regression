---
title: "Energy Data"
author: "Rami Krispin"
date: last-modified
format: 
  html:
    code-fold: false 
    warning: false
    toc: true
---

In this notebook, we will pull the required time series data from the EIA API and reformat it.


The EIA API is a great resource for time series data. It provides access to various types of time series data from the energy industry. We will use the EIAapi library to pull the following time series:

- Number of natural gas consumers in California
- US monthly demand for natural gas 
- Hourly demand for electricity in California by balancing authority subregion PGAE


## Load the Libraries

We will use the EIAapi library to pull the required time series from the API and use the plotly library to plot the data, and the tsibble library to reformat the data into time series objects.

```{r}
library(EIAapi)
library(plotly)
library(tsibble)
```


## API Settings

```{r}
#| label: loading the API key
api_key <- Sys.getenv("EIA_API_KEY")
```

## Number of Natural Gas Consumers in California

Series details:

- **Series description:** Total number of natural gas consumers in California 
- **Area:** California
- **Process:** Number of Residential Consumers
- **API dashboard [link](https://www.eia.gov/opendata/browser/natural-gas/cons/num?frequency=annual&data=value;&facets=duoarea;process;&duoarea=SCA;&process=VN3;&sortColumn=period;&sortDirection=desc;)**
- **API path:** 'natural-gas/cons/num/data/'
- **Query schema:**

``` json
{
    "frequency": "annual",
    "data": [
        "value"
    ],
    "facets": {
        "duoarea": [
            "SCA"
        ],
        "process": [
            "VN3"
        ]
    },
    "start": null,
    "end": null,
    "sort": [
        {
            "column": "period",
            "direction": "desc"
        }
    ],
    "offset": 0,
    "length": 5000
}
```

```{r}
ts_1 <- eia_get(
        api_key = api_key,
        api_path = "natural-gas/cons/num/data/",
        # frequency = "monthly",
        data = "value",
        facets = list(duoarea = "SCA", process = "VN3") 
    ) |>
    dplyr::arrange(period)

head(ts_1)
```


```{r}
ca_consumers_n_gas <- ts_1 |>
    dplyr::select(year = period, y = value, series_id = duoarea) |>
    dplyr::filter(year > 1986) |>
    as_tsibble(index = year) |>
    dplyr::select(year, y)

head(ca_consumers_n_gas)
```

Save the data to a CSV file:

```{r}
file_path <- paste(here::here(), "data/csv/ca_consumers_n_gas.csv", sep = "/")
write.csv(ca_consumers_n_gas,file_path, row.names = FALSE)
```

```{r}
plot_ly(data = ca_consumers_n_gas, x = ~ year, y = ~ y, type = "scatter", mode = "lines") |>
plotly::layout(title = "Number of Natural Gas Consumers in California", 
yaxis = list(title = "Number of Consumers"),
xaxis = list(title = "Period")) 
```

## US Monthly Demand for Natural Gas 

Series details:

- **Series description:** US total monthly demand for natural gas 
- **Area:** US
- **Process:** Delivered to Consumers
- **API dashboard [link](https://www.eia.gov/opendata/browser/natural-gas/cons/sum?frequency=monthly&data=value;&facets=duoarea;process;&duoarea=NUS;&process=VGT;&sortColumn=period;&sortDirection=desc;)**
- **API path:** 'natural-gas/cons/sum/data/'
- **Query schema:**

``` json
{
    "frequency": "monthly",
    "data": [
        "value"
    ],
    "facets": {
        "duoarea": [
            "NUS"
        ],
        "process": [
            "VGT"
        ]
    },
    "start": null,
    "end": null,
    "sort": [
        {
            "column": "period",
            "direction": "desc"
        }
    ],
    "offset": 0,
    "length": 5000
}
```


Let's pull the data:

```{r}
ts_2 <- eia_get(
        api_key = api_key,
        api_path = "natural-gas/cons/sum/data/",
        frequency = "monthly",
        data = "value",
        facets = list(duoarea = "NUS", process = "VGT")
    ) |>
    dplyr::arrange(period)
```
And reformat it:

```{r}
us_natural_gas <- ts_2 |>
    dplyr::mutate(
        date = lubridate::ym(period),
        index = yearmonth(date)
    ) |>
    dplyr::select(date, index, y = value, series_id = duoarea) |>
    dplyr::arrange(date) |>
    as_tsibble(index = date)

us_natural_gas |> head()
```

And plot it:

```{r}
plot_ly(data = us_natural_gas, x = ~index, y = ~y, type = "scatter", mode = "lines") |>
    plotly::layout(
        title = "US Monthly Demand for Natural Gas",
        yaxis = list(title = "MMCF"),
        xaxis = list(title = "Period")
    )
```

Save the data:

```{r}
us_natural_gas <- us_natural_gas |> 
as.data.frame() |>
dplyr::select(date, y)
write.csv(us_natural_gas, paste(here::here(), "data/csv/us_natural_gas.csv", sep = "/"), row.names = FALSE)
```

## Hourly Demand for Electricity in California by Balancing Authority Subregion PGAE

Series details:

- **Series description:** Hourly demand by balancing authority subregion. Source: Form EIA-930 Product: Hourly Electric Grid Monitor
- **Balancing authority:** CISO
- **Subregion:** PGAE
- **API dashboard [link](https://www.eia.gov/opendata/browser/electricity/rto/region-sub-ba-data?frequency=hourly&data=value;&facets=subba;parent;&subba=PGAE;&parent=CISO;&sortColumn=period;&sortDirection=desc;)**
- **API path:** `electricity/rto/region-sub-ba-data/data/`
- **Query schema:**
  
``` json
{
    "frequency": "hourly",
    "data": [
        "value"
    ],
    "facets": {
        "subba": [
            "PGAE"
        ],
        "parent": [
            "CISO"
        ]
    },
    "start": null,
    "end": null,
    "sort": [
        {
            "column": "period",
            "direction": "desc"
        }
    ],
    "offset": 0,
    "length": 5000
}
```

Pulling the series:
```{r}
ts_3 <- eia_backfill(
    api_key = api_key,
    api_path = "electricity/rto/region-sub-ba-data/data/",
    frequency = "hourly",
    data = "value",
    facets = list(subba = "PGAE", parent = "CISO"),
    start = as.POSIXct("2019-01-01"),
    end = as.POSIXct("2026-02-01"),
    offset = 1500
) |> dplyr::arrange(time)

head(ts_3)
```


Converting the series to a `tsibble` object:
```{r}
ca_electricty <- ts_3 |>
    dplyr::distinct() |>
    dplyr::select(date_time = time, y = value, series_id = subba) |>
    as_tsibble(index = date_time)
```


Save the data:

```{r}
file_path <- paste(here::here(), "data/csv/ca_electricty.csv", sep = "/")
write.csv(ca_electricty |> dplyr::select(date_time, y), file_path, row.names = FALSE)
```


Plotting the series:

```{r}
plot_ly(data = ca_electricty, x = ~ index, y = ~ y, type = "scatter", mode = "lines") |>
plotly::layout(title = "Hourly Demand for Electricity in California Subregion PGAE", 
yaxis = list(title = "MegaWatthHours"),
xaxis = list(title = "Period"))  
```

## Saving the Data

```{r}
save(ca_consumers_n_gas, us_natural_gas, ca_electricty |> dplyr::select(index, y),
    file = paste(here::here(), "data/RData/energy.RData", sep = "/")
)
```